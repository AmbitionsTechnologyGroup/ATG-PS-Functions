<#This script will use chocolatey to install Dell Command Update to the latest version, then use it to update drivers and BIOS.
To run this script directly from Powershell without copying and pasting, run:
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
Set-ExecutionPolicy Bypass -Scope Process -Force; iwr https://download.ambitionsgroup.com/Scripts/DCU_AUTO.txt -UseBasicParsing | iex
#>

#Install and update Chocolatey if Needed
If (Get-Command choco -errorAction SilentlyContinue) {
	choco upgrade chocolatey
} Else {
	Set-ExecutionPolicy Bypass -Scope Process -Force; iwr https://download.ambitionsgroup.com/Scripts/installchoco.txt -UseBasicParsing | iex
}

Write-Host "Checking if Dell Command | Update is current."
	$DCUInstalledVersion = (Get-Package -Provider Programs -IncludeWindowsInstaller -Name "Dell Command | Update").Version
	$DCUAvailableVersion = choco list dellcommandupdate
	$DCUAvailableVersion = ($DCUAvailableVersion | Select-String -Pattern "DellCommandUpdate " -SimpleMatch).Line
	$DCUAvailableVersion = $DCUAvailableVersion.split(" ",[System.StringSplitOptions]::RemoveEmptyEntries)[1]

If ($DCUInstalledVersion -eq $DCUAvailableVersion) {
	Write-Host "Dell Command | Update is current."
} Else {
	Write-Host "Dell Command | Update is not current. Updating from version $DCUInstalledVersion to $DCUAvailableVersion."
	#Remove any programs listed through "Add and remove programs"
	If (Get-WmiObject -Class Win32_Product | Where-Object {$_.Name -like "*Dell*Update*"}) {
		(Get-WmiObject -Class Win32_Product | Where-Object {$_.Name -like "*Dell*Update*"}).Uninstall()
	}

	#Remove any Windows 10 "Apps"
	Get-AppxPackage *Dell*Update* | Remove-AppxPackage

	#Starts the IPMI Service if needed
	If ((Get-Service -Name IPMIDRV -ErrorAction SilentlyContinue).Status -ne "Running" -and (Get-Service -Name IPMIDRV -ErrorAction SilentlyContinue).Status) {Start-Service -Name IPMIDRV -PassThru}

	#Install the latest
		Choco upgrade dellcommandupdate -y --force --ignorechecksums
}

#Configure and run Dell Command Update
If (Test-Path 'C:\Program Files (x86)\Dell\CommandUpdate\dcu-cli.exe') {
	& 'C:\Program Files (x86)\Dell\CommandUpdate\dcu-cli.exe' /configure -autoSuspendBitLocker=enable
	& 'C:\Program Files (x86)\Dell\CommandUpdate\dcu-cli.exe' /applyUpdates -reboot=disable
} ElseIf (Test-Path 'C:\Program Files\Dell\CommandUpdate\dcu-cli.exe') {
	& 'C:\Program FilesDell\CommandUpdate\dcu-cli.exe' /configure -autoSuspendBitLocker=enable
	& 'C:\Program Files\Dell\CommandUpdate\dcu-cli.exe' /applyUpdates -reboot=disable
} Else {
	Write-Error "Dell Command Update CLI not found."
}
